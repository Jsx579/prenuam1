{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'Prototipo/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'Prototipo/css/styles.css' %}">
    <title>Panel de Auditor - NUAM</title>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{% url 'Bienvenida' %}">
                <img src="{% static 'Prototipo/svg/6341953_logo_img_patrocinada-convertido-de-png.svg' %}" alt="NUAM Logo" height="40" class="me-2">
            </a>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="d-flex align-items-center ms-auto">
                    {% if request.user.is_authenticated %}
                        <span class="navbar-text me-3 text-white">
                            <strong>{{ request.user.nombre }}</strong> ({{ request.user.rol.nombre }})
                        </span>
                    {% endif %}
                    <a href="{% url 'CerrarSesion' %}" class="btn btn-outline-light btn-sm">Cerrar Sesión</a>
                </div>
            </div>
        </div>
    </nav>

    {% block title %}Panel de Auditor{% endblock %}
    {% block content %}
    <div class="container mt-5 flex-grow-1">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary fw-bold mb-2">{{ titulo }}</h2>
                <p class="text-muted mb-0">Revise las calificaciones y el historial de actividad del sistema.</p>
            </div>
            <div>
                <a href="{% url 'PanelReportes' %}" class="btn btn-primary shadow-sm">
                    <i class="bi bi-file-earmark-bar-graph"></i> Generar Reportes
                </a>
            </div>
        </div>
        
        <div class="row g-4">
            
            <div class="col-lg-7">
                <div class="card shadow-sm h-100 border-0 rounded-3">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0 fw-semibold">
                            <i class="bi bi-clipboard-check"></i> Listado de Calificaciones
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                            <table class="table table-hover table-sm m-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="fw-semibold">ID</th>
                                        <th class="fw-semibold">Instrumento</th>
                                        <th class="fw-semibold">Creador</th>
                                        <th class="fw-semibold">Estado</th>
                                        <th class="fw-semibold">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for calificacion in calificaciones %}
                                        <tr {% if calificacion.estado == 'Pendiente' %}class="table-warning"{% endif %}>
                                            <td class="align-middle">{{ calificacion.pk }}</td>
                                            <td class="align-middle">{{ calificacion.instrumento }}</td>
                                            <td class="align-middle">{{ calificacion.usuario_creador.nombre }}</td>
                                            <td class="align-middle">
                                                <span class="badge 
                                                    {% if calificacion.estado == 'Aprobada' %}bg-success
                                                    {% elif calificacion.estado == 'Rechazada' %}bg-danger
                                                    {% else %}bg-warning text-dark{% endif %}">
                                                    {{ calificacion.estado }}
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                <a href="{% url 'CalificacionRevisar' calificacion.pk %}" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye"></i> Revisar
                                                </a>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-5">
                                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                                <span>No hay calificaciones registradas.</span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm h-100 border-0 rounded-3">
                    <div class="card-header bg-secondary text-white py-3">
                        <h5 class="mb-0 fw-semibold">
                            <i class="bi bi-clock-history"></i> Historial de Actividad
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="p-3 bg-light border-bottom">
                            <p class="mb-0 text-muted small">
                                <i class="bi bi-info-circle"></i> Mostrando los últimos 100 registros del sistema.
                            </p>
                        </div>
                        <div class="table-responsive" style="max-height: 540px; overflow-y: auto;">
                            <table class="table table-sm table-hover m-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="fw-semibold" style="width: 30%;">Fecha/Hora</th>
                                        <th class="fw-semibold" style="width: 20%;">Usuario</th>
                                        <th class="fw-semibold" style="width: 25%;">Acción</th>
                                        <th class="fw-semibold" style="width: 25%;">Detalle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logs %}
                                        <tr>
                                            <td class="align-middle small">{{ log.fecha_hora|date:"d M H:i" }}</td>
                                            <td class="align-middle small">{{ log.usuario.nombre|default:"Sistema"|truncatechars:10 }}</td>
                                            <td class="align-middle small">{{ log.accion|truncatechars:15 }}</td>
                                            <td class="align-middle small" title="{{ log.detalle_cambio|striptags }}">
                                                {{ log.detalle_cambio|truncatechars:20 }}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-5">
                                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                                <span>No hay registros de actividad recientes.</span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-top py-4 mt-5">
        <div class="container">
            <ul class="nav justify-content-center mb-2">
                <li class="nav-item">
                    <a class="nav-link text-primary" href="https://www.nuam.com/">Inicio</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-primary" href="https://www.bolsadesantiago.com/mercado_en_vivo">Bolsa en vivo</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-primary" href="tel:+562 2399 3000">Contacto</a>
                </li>
            </ul>
            <p class="text-center text-muted small mb-0">© 2024 NUAM. Todos los derechos reservados.</p>
        </div>
    </footer>
{% endblock %}

    <script src="{% static 'Prototipo/js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>